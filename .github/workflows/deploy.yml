name: Deploy cc3s (globalcxca)

on:
  push:
    branches:
      - main
      - master
      - github-actions
      - nonprod
  workflow_dispatch:
    inputs:
      tier:
        description: "Tier to deploy to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  Deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.tier }}
    env:
      APP: globalcxca
      AWS_REGION: us-east-1
      TZ: America/New_York
      TIER: ${{ inputs.tier || '' }}

    steps:
      - uses: "actions/checkout@v6.0.1"

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Build application
        working-directory: ./client
        env:
          CI: false
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          role-to-assume: ${{ secrets.CICD_ROLE_ARN }}
          role-session-name: ${{ env.TIER }}-${{ env.APP }}-deploy-${{ github.ref_name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Retrieve SSM parameters
        run: |
          PARAMETER_PATH="/analysistools/${{ env.TIER }}/${{ env.APP }}"

          # Define parameters to retrieve (SSM name = ENV_VAR_NAME)
          declare -A PARAMS=(
            ["cloudfront_distribution_id"]="CLOUDFRONT_DISTRIBUTION_ID"
            ["cloudfront_domain_name"]="CLOUDFRONT_DOMAIN_NAME"
            ["cloudfront_s3_bucket"]="CLOUDFRONT_S3_BUCKET"
          )

          # Retrieve each parameter and export to environment
          for ssm_name in "${!PARAMS[@]}"; do
            env_var="${PARAMS[$ssm_name]}"
            value=$(aws ssm get-parameter \
              --name "${PARAMETER_PATH}/${ssm_name}" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text)
            echo "${env_var}=${value}" >> $GITHUB_ENV
            echo "Retrieved ${ssm_name} -> ${env_var}"
          done

      - name: Copy build assets to S3
        run: |
          aws s3 sync client/docs/ s3://${{ env.CLOUDFRONT_S3_BUCKET }} --delete

      - name: Create CloudFront invalidation
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "CloudFront invalidation created: ${INVALIDATION_ID}"
          echo "Distribution: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "Domain: ${{ env.CLOUDFRONT_DOMAIN_NAME }}"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tier:** ${{ env.TIER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.CLOUDFRONT_DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket:** ${{ env.CLOUDFRONT_S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Distribution:** ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
